import React, { useState, useEffect } from 'react';
import { Upload, TrendingUp, TrendingDown, AlertTriangle, CheckCircle, BarChart3, PieChart, Calendar, Zap, Target, FileText, LogOut, Menu, X } from 'lucide-react';

// ⚠️ REPLACE THESE WITH YOUR SUPABASE CREDENTIALS
const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // Get from Supabase dashboard
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // Get from Supabase dashboard

// Simple Supabase client (no external libraries needed for demo)
const supabaseClient = {
  auth: {
    signIn: async (email, password) => {
      const response = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY
        },
        body: JSON.stringify({ email, password })
      });
      return response.json();
    },
    signUp: async (email, password) => {
      const response = await fetch(`${SUPABASE_URL}/auth/v1/signup`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY
        },
        body: JSON.stringify({ email, password })
      });
      return response.json();
    }
  },
  from: (table) => ({
    select: (columns = '*') => ({
      eq: (column, value) => ({
        execute: async (token) => {
          const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${value}&select=${columns}`, {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${token}`
            }
          });
          return { data: await response.json() };
        }
      }),
      execute: async (token) => {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=${columns}`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${token}`
          }
        });
        return { data: await response.json() };
      }
    }),
    insert: (data) => ({
      execute: async (token) => {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${token}`,
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(data)
        });
        return { data: await response.json() };
      }
    })
  })
};

export default function FinanceAI() {
  const [user, setUser] = useState(null);
  const [token, setToken] = useState(null);
  const [view, setView] = useState('login');
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [loading, setLoading] = useState(false);
  const [financialData, setFinancialData] = useState(null);
  const [useDemoMode, setUseDemoMode] = useState(true); // Toggle for demo vs real backend

  // Check if Supabase is configured
  const isBackendConfigured = SUPABASE_URL !== 'YOUR_SUPABASE_URL';

  useEffect(() => {
    // Check for existing session
    const savedToken = localStorage.getItem('finance_token');
    const savedUser = localStorage.getItem('finance_user');
    if (savedToken && savedUser) {
      setToken(savedToken);
      setUser(JSON.parse(savedUser));
      setView('dashboard');
      loadUserData(savedToken);
    }
  }, []);

  const login = async (email, password) => {
    setLoading(true);
    
    if (!isBackendConfigured || useDemoMode) {
      // Demo mode - simulate login
      setTimeout(() => {
        const demoUser = { email, name: email.split('@')[0], id: 'demo-user' };
        setUser(demoUser);
        localStorage.setItem('finance_user', JSON.stringify(demoUser));
        loadDemoData();
        setView('dashboard');
        setLoading(false);
      }, 1200);
      return;
    }

    // Real backend login
    try {
      const result = await supabaseClient.auth.signIn(email, password);
      if (result.access_token) {
        setToken(result.access_token);
        setUser(result.user);
        localStorage.setItem('finance_token', result.access_token);
        localStorage.setItem('finance_user', JSON.stringify(result.user));
        await loadUserData(result.access_token);
        setView('dashboard');
      } else {
        alert('Login failed. Using demo mode instead.');
        setUseDemoMode(true);
        login(email, password);
      }
    } catch (error) {
      console.error('Login error:', error);
      alert('Login failed. Using demo mode.');
      setUseDemoMode(true);
      login(email, password);
    }
    setLoading(false);
  };

  const signup = async (email, password) => {
    setLoading(true);
    
    if (!isBackendConfigured) {
      alert('Backend not configured. Please set up Supabase first.');
      setLoading(false);
      return;
    }

    try {
      const result = await supabaseClient.auth.signUp(email, password);
      if (result.user) {
        alert('Account created! Please check your email to verify.');
        setView('login');
      }
    } catch (error) {
      alert('Signup failed: ' + error.message);
    }
    setLoading(false);
  };

  const loadUserData = async (authToken) => {
    if (!isBackendConfigured || useDemoMode) {
      loadDemoData();
      return;
    }

    try {
      // Load transactions from Supabase
      const { data: transactions } = await supabaseClient
        .from('transactions')
        .select('*')
        .execute(authToken);

      // Load insights
      const { data: insights } = await supabaseClient
        .from('insights')
        .select('*')
        .execute(authToken);

      // Process and set data
      setFinancialData(processTransactionData(transactions, insights));
    } catch (error) {
      console.error('Error loading data:', error);
      loadDemoData();
    }
  };

  const loadDemoData = () => {
    setFinancialData({
      currentMonth: { totalIncome: 12450, totalExpenses: 8230, netCashFlow: 4220, profitMargin: 33.9 },
      previousMonth: { totalIncome: 10200, totalExpenses: 7100, netCashFlow: 3100 },
      historical: [
        { month: 'Oct', income: 9800, expenses: 6900, net: 2900 },
        { month: 'Nov', income: 10200, expenses: 7100, net: 3100 },
        { month: 'Dec', income: 12450, expenses: 8230, net: 4220 }
      ],
      categories: [
        { id: 1, name: 'Client Revenue', type: 'income', amount: 8200, transactions: 12, trend: 18 },
        { id: 2, name: 'Product Sales', type: 'income', amount: 2850, transactions: 45, trend: 5 },
        { id: 3, name: 'Consulting', type: 'income', amount: 1400, transactions: 4, trend: -3 },
        { id: 4, name: 'Software & Tools', type: 'expense', amount: 1890, transactions: 18, trend: 12 },
        { id: 5, name: 'Marketing', type: 'expense', amount: 2340, transactions: 23, trend: 25 },
        { id: 6, name: 'Operations', type: 'expense', amount: 2100, transactions: 31, trend: -5 }
      ],
      insights: [
        { id: 1, priority: 'high', title: 'Subscription Stack Bloat', description: 'You have 8 SaaS subscriptions with 4 overlapping features. Consolidation could save significant costs.', impact: '$340/mo savings', action: 'Review & consolidate tools', tags: ['Do Now', 'Quick Win'] },
        { id: 2, priority: 'medium', title: 'Income Concentration Risk', description: 'Client Revenue accounts for 65% of income. A single client loss could impact cash flow by 40%.', impact: 'High risk', action: 'Diversify client base', tags: ['Watch'] },
        { id: 3, priority: 'high', title: 'Marketing ROI Spike', description: 'Marketing spend increased 25% but revenue grew 35%. This channel is outperforming.', impact: '+$1,200 potential', action: 'Increase budget', tags: ['Do Now'] }
      ],
      uploads: [
        { id: 1, filename: 'stripe_export_dec.csv', date: '2024-12-28', rows: 89 },
        { id: 2, filename: 'bank_statement_dec.csv', date: '2024-12-27', rows: 58 }
      ]
    });
  };

  const processTransactionData = (transactions, insights) => {
    // Convert raw transaction data to dashboard format
    // This would calculate totals, categorize, etc.
    return {
      currentMonth: { totalIncome: 0, totalExpenses: 0, netCashFlow: 0, profitMargin: 0 },
      previousMonth: { totalIncome: 0, totalExpenses: 0, netCashFlow: 0 },
      historical: [],
      categories: [],
      insights: insights || [],
      uploads: []
    };
  };

  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    setLoading(true);
    setView('processing');

    if (!isBackendConfigured || useDemoMode) {
      // Demo mode - simulate upload
      setTimeout(() => {
        loadDemoData();
        setView('dashboard');
        setLoading(false);
      }, 3000);
      return;
    }

    // Real upload to Supabase Storage
    try {
      // 1. Upload file to Supabase Storage
      const fileName = `${user.id}/${Date.now()}_${file.name}`;
      const formData = new FormData();
      formData.append('file', file);

      const uploadResponse = await fetch(`${SUPABASE_URL}/storage/v1/object/user-uploads/${fileName}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'apikey': SUPABASE_ANON_KEY
        },
        body: formData
      });

      const { path } = await uploadResponse.json();

      // 2. Create upload record
      const { data: upload } = await supabaseClient
        .from('uploads')
        .insert({
          user_id: user.id,
          filename: file.name,
          file_url: path,
          status: 'processing'
        })
        .execute(token);

      // 3. Trigger processing function
      await fetch(`${SUPABASE_URL}/functions/v1/process-upload`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ fileUrl: path, uploadId: upload[0].id })
      });

      // 4. Reload data
      await loadUserData(token);
      setView('dashboard');
    } catch (error) {
      console.error('Upload error:', error);
      alert('Upload failed. Using demo mode.');
      loadDemoData();
      setView('dashboard');
    }
    setLoading(false);
  };

  const logout = () => {
    setUser(null);
    setToken(null);
    localStorage.removeItem('finance_token');
    localStorage.removeItem('finance_user');
    setView('login');
  };

  if (!user) return <LoginScreen onLogin={login} onSignup={signup} loading={loading} demoMode={!isBackendConfigured} />;
  if (view === 'processing') return <ProcessingScreen />;

  return (
    <div className="flex h-screen bg-gray-50">
      {!isBackendConfigured && (
        <div className="fixed top-0 left-0 right-0 bg-yellow-500 text-white px-4 py-2 text-center text-sm z-50">
          ⚠️ Demo Mode - Set up Supabase to enable real backend
        </div>
      )}
      
      <aside className={`${sidebarOpen ? 'w-64' : 'w-20'} bg-white border-r border-gray-200 transition-all duration-300 flex flex-col ${!isBackendConfigured ? 'mt-10' : ''}`}>
        <div className="p-6 border-b border-gray-200 flex items-center justify-between">
          {sidebarOpen && (
            <div className="flex items-center space-x-2">
              <div className="w-8 h-8 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center">
                <Zap className="w-5 h-5 text-white" />
              </div>
              <span className="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">FinanceAI</span>
            </div>
          )}
          <button onClick={() => setSidebarOpen(!sidebarOpen)} className="text-gray-500 hover:text-gray-700">
            {sidebarOpen ? <X className="w-5 h-5" /> : <Menu className="w-5 h-5" />}
          </button>
        </div>
        <nav className="flex-1 p-4 space-y-2">
          <NavItem icon={BarChart3} label="Dashboard" active={view === 'dashboard'} onClick={() => setView('dashboard')} collapsed={!sidebarOpen} />
          <NavItem icon={Upload} label="Upload Data" active={view === 'upload'} onClick={() => setView('upload')} collapsed={!sidebarOpen} />
          <NavItem icon={Target} label="Insights" active={view === 'insights'} onClick={() => setView('insights')} collapsed={!sidebarOpen} />
          <NavItem icon={FileText} label="History" active={view === 'history'} onClick={() => setView('history')} collapsed={!sidebarOpen} />
        </nav>
        <div className="p-4 border-t border-gray-200">
          <NavItem icon={LogOut} label="Logout" onClick={logout} collapsed={!sidebarOpen} />
        </div>
      </aside>

      <main className="flex-1 overflow-y-auto">
        <header className="bg-white border-b border-gray-200 px-8 py-4">
          <h1 className="text-2xl font-bold text-gray-900">
            {view === 'dashboard' && 'Financial Dashboard'}
            {view === 'upload' && 'Upload Data'}
            {view === 'insights' && 'AI Insights'}
            {view === 'history' && 'Historical Data'}
          </h1>
          <p className="text-sm text-gray-600 mt-1">Welcome back, {user.name}</p>
        </header>

        <div className="p-8">
          {view === 'dashboard' && <DashboardView data={financialData} />}
          {view === 'upload' && <UploadView onUpload={handleFileUpload} uploads={financialData?.uploads || []} />}
          {view === 'insights' && <InsightsView insights={financialData?.insights || []} />}
          {view === 'history' && <HistoryView data={financialData} />}
        </div>
      </main>
    </div>
  );
}

function NavItem({ icon: Icon, label, active, onClick, collapsed }) {
  return (
    <button onClick={onClick} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${active ? 'bg-indigo-50 text-indigo-600' : 'text-gray-700 hover:bg-gray-100'}`}>
      <Icon className="w-5 h-5 flex-shrink-0" />
      {!collapsed && <span className="font-medium">{label}</span>}
    </button>
  );
}

function LoginScreen({ onLogin, onSignup, loading, demoMode }) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isSignup, setIsSignup] = useState(false);

  const handleSubmit = () => {
    if (isSignup) {
      onSignup(email, password);
    } else {
      onLogin(email || 'demo@financeai.com', password || 'demo123');
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
        {demoMode && (
          <div className="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <p className="text-sm text-yellow-800">
              <strong>Demo Mode:</strong> Configure Supabase in the code to enable real backend
            </p>
          </div>
        )}
        
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl mb-4">
            <Zap className="w-8 h-8 text-white" />
          </div>
          <h1 className="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2">FinanceAI</h1>
          <p className="text-gray-600">AI-powered financial intelligence</p>
        </div>

        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
            <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="you@company.com" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="••••••••" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
          </div>
          <button onClick={handleSubmit} disabled={loading} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-indigo-700 hover:to-purple-700 transition-all disabled:opacity-50">
            {loading ? 'Loading...' : isSignup ? 'Sign Up' : 'Sign In'}
          </button>
        </div>

        <div className="mt-6 text-center">
          <button onClick={() => setIsSignup(!isSignup)} className="text-sm text-indigo-600 hover:text-indigo-700">
            {isSignup ? 'Already have an account? Sign in' : "Don't have an account? Sign up"}
          </button>
        </div>
      </div>
    </div>
  );
}

function ProcessingScreen() {
  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl p-12 max-w-lg w-full text-center">
        <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl mb-6 animate-pulse">
          <Zap className="w-10 h-10 text-white" />
        </div>
        <h2 className="text-3xl font-bold text-gray-900 mb-2">Processing Your Data</h2>
        <p className="text-gray-600">AI is analyzing your financial data...</p>
      </div>
    </div>
  );
}

// Dashboard, Upload, Insights, and History components remain the same as before
function DashboardView({ data }) {
  if (!data) return <div className="text-center py-12"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div></div>;

  const { currentMonth, historical, categories } = data;

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <MetricCard title="Total Income" value={`$${currentMonth.totalIncome.toLocaleString()}`} icon={TrendingUp} color="emerald" />
        <MetricCard title="Total Expenses" value={`$${currentMonth.totalExpenses.toLocaleString()}`} icon={TrendingDown} color="red" />
        <MetricCard title="Net Cash Flow" value={`$${currentMonth.netCashFlow.toLocaleString()}`} icon={BarChart3} color="blue" />
        <MetricCard title="Profit Margin" value={`${currentMonth.profitMargin}%`} icon={PieChart} color="purple" />
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <CategoryBreakdown title="Income Sources" categories={categories.filter(c => c.type === 'income')} type="income" />
        <CategoryBreakdown title="Expense Categories" categories={categories.filter(c => c.type === 'expense')} type="expense" />
      </div>
    </div>
  );
}

function MetricCard({ title, value, icon: Icon, color }) {
  const colors = { emerald: 'from-emerald-500 to-green-500', red: 'from-red-500 to-orange-500', blue: 'from-blue-500 to-indigo-500', purple: 'from-purple-500 to-pink-500' };
  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <div className="flex items-center justify-between mb-4">
        <span className="text-sm font-medium text-gray-600">{title}</span>
        <div className={`w-10 h-10 rounded-lg bg-gradient-to-br ${colors[color]} flex items-center justify-center`}>
          <Icon className="w-5 h-5 text-white" />
        </div>
      </div>
      <div className="text-3xl font-bold text-gray-900">{value}</div>
    </div>
  );
}

function CategoryBreakdown({ title, categories, type }) {
  const total = categories.reduce((sum, c) => sum + c.amount, 0);
  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <h3 className="text-lg font-bold text-gray-900 mb-4">{title}</h3>
      <div className="space-y-4">
        {categories.map(cat => (
          <div key={cat.id}>
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-medium text-gray-700">{cat.name}</span>
              <div className="text-sm font-bold text-gray-900">${cat.amount.toLocaleString()}</div>
            </div>
            <div className="relative h-2 bg-gray-100 rounded-full">
              <div className={`absolute top-0 left-0 h-full rounded-full ${type === 'income' ? 'bg-emerald-500' : 'bg-red-500'}`} style={{ width: `${(cat.amount / total) * 100}%` }}></div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function UploadView({ onUpload, uploads }) {
  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
      <div className="text-center mb-6">
        <Upload className="w-16 h-16 text-indigo-600 mx-auto mb-4" />
        <h2 className="text-2xl font-bold text-gray-900 mb-2">Upload Financial Data</h2>
        <p className="text-gray-600">CSV from Stripe, PayPal, Razorpay, or bank exports</p>
      </div>
      <div className="border-4 border-dashed border-gray-300 rounded-xl p-12 text-center hover:border-indigo-400 transition-all">
        <input type="file" accept=".csv,.xlsx,.xls" onChange={onUpload} className="hidden" id="file-upload" />
        <label htmlFor="file-upload" className="cursor-pointer">
          <p className="text-lg font-semibold text-gray-700">Drop file or click to browse</p>
        </label>
      </div>
    </div>
  );
}

function InsightsView({ insights }) {
  return (
    <div className="space-y-4">
      {insights.map(insight => (
        <div key={insight.id} className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <h3 className="text-lg font-bold text-gray-900 mb-2">{insight.title}</h3>
          <p className="text-gray-700 mb-3">{insight.description}</p>
          <div className="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-sm font-semibold inline-block">{insight.impact}</div>
        </div>
      ))}
    </div>
  );
}

function HistoryView({ data }) {
  return (
    <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
      <h2 className="text-xl font-bold text-gray-900 mb-6">Historical Data</h2>
      <div className="space-y-4">
        {data?.historical.map((month, idx) => (
          <div key={idx} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <div className="font-semibold text-gray-900">{month.month}</div>
            <div className="text-sm font-bold text-blue-600">${month.net.toLocaleString()}</div>
          </div>
        ))}
      </div>
    </div>
  );
}
